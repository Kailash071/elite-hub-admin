{% extends "layouts/admin.njk" %}

{% block content %}
<div class="container-xxl flex-grow-1 container-p-y">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="fw-bold py-3 mb-0">Inventory Management</h4>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Category</label>
                    <select id="categoryFilter" class="form-select">
                        <option value="">All Categories</option>
                        {% for cat in categories %}
                        <option value="{{ cat._id }}">{{ cat.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Stock Status</label>
                    <select id="stockStatusFilter" class="form-select">
                        <option value="">All Statuses</option>
                        <option value="in_stock">In Stock</option>
                        <option value="low_stock">Low Stock</option>
                        <option value="out_of_stock">Out of Stock</option>
                    </select>
                </div>
                 <div class="col-md-3">
                    <label class="form-label">Brand</label>
                    <select id="brandFilter" class="form-select">
                        <option value="">All Brands</option>
                        {% for brand in brands %}
                        <option value="{{ brand._id }}">{{ brand.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Inventory Table -->
    <div class="card">
        <div class="table-responsive">
            <table class="table table-hover" id="inventoryTable">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>SKU</th>
                        <th>Current Stock</th>
                        <th>Status</th>
                        <th>Quick Update</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- DataTable -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
let inventoryTable;

document.addEventListener('DOMContentLoaded', function() {
    inventoryTable = $('#inventoryTable').DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: '/inventory/datatable',
            type: 'POST',
            data: function(d) {
                d.category = $('#categoryFilter').val();
                d.stockStatus = $('#stockStatusFilter').val();
                d.brand = $('#brandFilter').val();
            }
        },
        columns: [
            { 
                data: 'name',
                name: 'name',
                render: function(data, type, row) {
                    const img = (row.images && row.images.length > 0) ? `<img src="${row.images[0]}" class="rounded me-2" width="40" height="40" style="object-fit: cover;">` : 
                                            `<div class="avatar avatar-sm me-2"><span class="avatar-initial rounded bg-label-secondary"><i class="bx bx-package"></i></span></div>`;
                    const brandName = row.brand ? row.brand.name : 'No Brand';
                    return `<div class="d-flex align-items-center">
                                ${img}
                                <div>
                                    <h6 class="mb-0 text-truncate" style="max-width: 200px;">${data}</h6>
                                    <small class="text-muted">${brandName}</small>
                                </div>
                            </div>`;
                }
            },
            { data: 'sku', name: 'sku' },
            { 
                data: 'stockQuantity', 
                name: 'stockQuantity',
                render: function(data, type, row) {
                    const threshold = row.lowStockThreshold || 5;
                    return `<span class="fw-bold" id="stock-val-${row._id}">${data || 0}</span>
                            <small class="text-muted d-block">Threshold: ${threshold}</small>`;
                }
            },
            { 
                data: 'stockStatus', 
                name: 'stockStatus',
                render: function(data, type, row) {
                    let color = 'success';
                    if(data === 'low_stock') color = 'warning';
                    if(data === 'out_of_stock') color = 'danger';
                    const label = data ? data.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Unknown';
                    return `<span class="badge bg-label-${color}" id="status-val-${row._id}">${label}</span>`;
                }
            },
            {
                data: null,
                orderable: false,
                render: function(data, type, row) {
                    return `<div class="d-flex align-items-center gap-2">
                                <button type="button" class="btn btn-icon btn-sm btn-outline-danger" onclick="updateStock('${row._id}', 'subtract', 1)">
                                    <i class="bx bx-minus"></i>
                                </button>
                                <input type="number" class="form-control form-control-sm text-center" style="width: 70px;" value="${row.stockQuantity || 0}" 
                                       onchange="updateStock('${row._id}', 'set', this.value)">
                                <button type="button" class="btn btn-icon btn-sm btn-outline-success" onclick="updateStock('${row._id}', 'add', 1)">
                                    <i class="bx bx-plus"></i>
                                </button>
                            </div>`;
                }
            }
        ],
        order: [[2, 'asc']], // Sort by stock ascending by default
        dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>t<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
    });

    // Filter listeners
    $('#categoryFilter, #stockStatusFilter, #brandFilter').on('change', function() {
        inventoryTable.ajax.reload();
    });
});

async function updateStock(id, action, value) {
    try {
        const response = await fetch(`/inventory/${id}/stock`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action, quantity: value })
        });
        
        const data = await response.json();
        
        if (data.success) {
           
            // Reload table to reflect changes (and potentially sort order changes if stock changed)
            inventoryTable.ajax.reload(null, false); // false = stay on current page
           
        } else {
            alert(data.message || 'Failed to update stock');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred');
    }
}
</script>
{% endblock %}
