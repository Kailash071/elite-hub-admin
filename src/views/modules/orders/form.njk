{% extends "layouts/admin.njk" %}

{% block title %}{{ 'Edit Order' if order else 'Add Order' }} - {{ APP_NAME }}{% endblock %}

{% set pageTitle = 'Edit Order' if order else 'Add Order' %}
{% set breadcrumbSection = "Orders" %}
{% set breadcrumbSectionUrl = "/orders" %}
{% set breadcrumbActive = 'Edit Order' if order else 'Add Order' %}
{% set currentPage = "orders" %}

{% block css %}
<style>
  .order-item-row { border-bottom: 1px solid #eee; margin-bottom: 15px; padding-bottom: 15px; }
  .order-item-row:last-child { border-bottom: none; }
</style>
{% endblock %}

{% block content %}
<form id="orderForm" action="{{ '/orders/' + order._id if order else '/orders' }}" method="POST" novalidate>
    {% if order %}
    <input type="hidden" name="_method" value="PUT">
    {% endif %}
    
    <div class="row">
        <!-- Main Order Information -->
        <div class="col-lg-8">
            <!-- Navigation Tabs -->
            <div class="card mb-4">
                <div class="card-header">
                    <ul class="nav nav-pills card-header-pills" role="tablist">
                        <li class="nav-item">
                            <button type="button" class="nav-link active" data-bs-toggle="tab" data-bs-target="#order-info" role="tab">
                                <i class="bx bx-receipt me-1"></i> Order Info
                            </button>
                        </li>
                        <li class="nav-item">
                            <button type="button" class="nav-link" data-bs-toggle="tab" data-bs-target="#order-items" role="tab">
                                <i class="bx bx-box me-1"></i> Items
                            </button>
                        </li>
                        <li class="nav-item">
                            <button type="button" class="nav-link" data-bs-toggle="tab" data-bs-target="#addresses" role="tab">
                                <i class="bx bx-map me-1"></i> Addresses
                            </button>
                        </li>
                        <li class="nav-item">
                            <button type="button" class="nav-link" data-bs-toggle="tab" data-bs-target="#shipping-payment" role="tab">
                                <i class="bx bx-credit-card me-1"></i> Shipping & Payment
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content">
                        <!-- Order Information Tab -->
                        <div class="tab-pane fade show active" id="order-info" role="tabpanel">
                            <div class="row">
                                {% if order %}
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Order Number</label>
                                        <input type="text" 
                                               class="form-control" 
                                               value="{{ order.orderNumber }}"
                                               readonly>
                                    </div>
                                </div>
                                {% endif %}
                                
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label" for="customer">Customer <span class="text-danger">*</span></label>
                                        <select class="form-select" id="customer" name="customer" required>
                                            <option value="">Select Customer</option>
                                            {% if customers %}
                                            {% for cust in customers %}
                                            <option value="{{ cust._id }}" 
                                                    data-email="{{ cust.email }}"
                                                    data-phone="{{ cust.phone or '' }}"
                                                    {{ 'selected' if (order and order.customer._id == cust._id) or formData.customer == cust._id }}>
                                                {{ cust.firstName }} {{ cust.lastName }} ({{ cust.email }})
                                            </option>
                                            {% endfor %}
                                            {% endif %}
                                        </select>
                                        <div class="invalid-feedback"></div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label" for="customerEmail">Customer Email</label>
                                        <input type="email" 
                                               class="form-control" 
                                               id="customerEmail"
                                               name="customerEmail" 
                                               value="{{ order.customerEmail if order else formData.customerEmail or '' }}"
                                               readonly>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label" for="customerPhone">Customer Phone</label>
                                        <input type="tel" 
                                               class="form-control" 
                                               id="customerPhone"
                                               name="customerPhone" 
                                               value="{{ order.customerPhone if order else formData.customerPhone or '' }}">
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label" for="status">Order Status</label>
                                        <select class="form-select" id="status" name="status">
                                            <option value="pending" {{ 'selected' if (order and order.status == 'pending') or (not order) }}>Pending</option>
                                            <option value="confirmed" {{ 'selected' if (order and order.status == 'confirmed') }}>Confirmed</option>
                                            <option value="processing" {{ 'selected' if (order and order.status == 'processing') }}>Processing</option>
                                            <option value="shipped" {{ 'selected' if (order and order.status == 'shipped') }}>Shipped</option>
                                            <option value="delivered" {{ 'selected' if (order and order.status == 'delivered') }}>Delivered</option>
                                            <option value="cancelled" {{ 'selected' if (order and order.status == 'cancelled') }}>Cancelled</option>
                                            <option value="returned" {{ 'selected' if (order and order.status == 'returned') }}>Returned</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label" for="currency">Currency</label>
                                        <select class="form-select" id="currency" name="currency">
                                            <option value="INR" {{ 'selected' if (order and order.currency == 'INR') or (not order) }}>INR</option>
                                            <option value="USD" {{ 'selected' if (order and order.currency == 'USD') }}>USD</option>
                                            <option value="EUR" {{ 'selected' if (order and order.currency == 'EUR') }}>EUR</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="col-12">
                                    <div class="mb-3">
                                        <label class="form-label" for="customerNotes">Customer Notes</label>
                                        <textarea class="form-control" 
                                                  id="customerNotes"
                                                  name="customerNotes" 
                                                  rows="2"
                                                  placeholder="Notes from customer">{{ order.customerNotes if order else formData.customerNotes or '' }}</textarea>
                                    </div>
                                </div>
                                
                                <div class="col-12">
                                    <div class="mb-3">
                                        <label class="form-label" for="adminNotes">Admin Notes</label>
                                        <textarea class="form-control" 
                                                  id="adminNotes"
                                                  name="adminNotes" 
                                                  rows="2"
                                                  placeholder="Internal notes">{{ order.adminNotes if order else formData.adminNotes or '' }}</textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Order Items Tab -->
                        <div class="tab-pane fade" id="order-items" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6>Order Items</h6>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addOrderItem()">
                                    <i class="bx bx-plus"></i> Add Item
                                </button>
                            </div>
                            
                            <div id="orderItemsContainer">
                                {% if order and order.items %}
                                {% for item in order.items %}
                                <div class="order-item-row" data-index="{{ loop.index0 }}">
                                    {% include "modules/orders/_item-form.njk" %}
                                </div>
                                {% endfor %}
                                {% else %}
                                <div class="text-center text-muted py-4">
                                    <i class="bx bx-box fs-1 d-block mb-2"></i>
                                    <p>No items added yet</p>
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Order Totals -->
                            <div class="card bg-light">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label" for="subtotal">Subtotal</label>
                                                <input type="number" 
                                                       class="form-control" 
                                                       id="subtotal"
                                                       name="subtotal" 
                                                       value="{{ order.subtotal if order else '0' }}"
                                                       step="0.01"
                                                       readonly>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label" for="shippingCost">Shipping Cost</label>
                                                <input type="number" 
                                                       class="form-control" 
                                                       id="shippingCost"
                                                       name="shippingCost" 
                                                       value="{{ order.shippingCost if order else '0' }}"
                                                       step="0.01">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label" for="taxAmount">Tax Amount</label>
                                                <input type="number" 
                                                       class="form-control" 
                                                       id="taxAmount"
                                                       name="taxAmount" 
                                                       value="{{ order.taxAmount if order else '0' }}"
                                                       step="0.01">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label" for="discountAmount">Discount Amount</label>
                                                <input type="number" 
                                                       class="form-control" 
                                                       id="discountAmount"
                                                       name="discountAmount" 
                                                       value="{{ order.discountAmount if order else '0' }}"
                                                       step="0.01">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label" for="couponCode">Coupon Code</label>
                                                <input type="text" 
                                                       class="form-control" 
                                                       id="couponCode"
                                                       name="couponCode" 
                                                       value="{{ order.couponCode if order else formData.couponCode or '' }}">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label" for="totalAmount">Total Amount</label>
                                                <input type="number" 
                                                       class="form-control" 
                                                       id="totalAmount"
                                                       name="totalAmount" 
                                                       value="{{ order.totalAmount if order else '0' }}"
                                                       step="0.01"
                                                       readonly>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Addresses Tab -->
                        <div class="tab-pane fade" id="addresses" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Shipping Address</h6>
                                        </div>
                                        <div class="card-body">
                                            {% include "modules/orders/_address-form.njk" with { addressType: 'shipping', address: order.shippingAddress if order } %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">Billing Address</h6>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="sameAsShipping" onchange="copyShippingToBilling()">
                                                <label class="form-check-label" for="sameAsShipping">Same as shipping</label>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            {% include "modules/orders/_address-form.njk" with { addressType: 'billing', address: order.billingAddress if order } %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Shipping & Payment Tab -->
                        <div class="tab-pane fade" id="shipping-payment" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Shipping Information</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label class="form-label" for="shippingMethod">Shipping Method</label>
                                                <select class="form-select" id="shippingMethod" name="shipping[method]">
                                                    <option value="standard" {{ 'selected' if (order and order.shipping.method == 'standard') or (not order) }}>Standard</option>
                                                    <option value="express" {{ 'selected' if (order and order.shipping.method == 'express') }}>Express</option>
                                                    <option value="overnight" {{ 'selected' if (order and order.shipping.method == 'overnight') }}>Overnight</option>
                                                </select>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label" for="carrier">Carrier</label>
                                                <select class="form-select" id="carrier" name="shipping[carrier]">
                                                    <option value="">Select Carrier</option>
                                                    <option value="BlueDart" {{ 'selected' if (order and order.shipping.carrier == 'BlueDart') }}>BlueDart</option>
                                                    <option value="DTDC" {{ 'selected' if (order and order.shipping.carrier == 'DTDC') }}>DTDC</option>
                                                    <option value="FedEx" {{ 'selected' if (order and order.shipping.carrier == 'FedEx') }}>FedEx</option>
                                                    <option value="DHL" {{ 'selected' if (order and order.shipping.carrier == 'DHL') }}>DHL</option>
                                                    <option value="India Post" {{ 'selected' if (order and order.shipping.carrier == 'India Post') }}>India Post</option>
                                                </select>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label" for="trackingNumber">Tracking Number</label>
                                                <input type="text" 
                                                       class="form-control" 
                                                       id="trackingNumber"
                                                       name="shipping[trackingNumber]" 
                                                       value="{{ order.shipping.trackingNumber if order else formData.trackingNumber or '' }}">
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label" for="estimatedDelivery">Estimated Delivery</label>
                                                <input type="datetime-local" 
                                                       class="form-control" 
                                                       id="estimatedDelivery"
                                                       name="shipping[estimatedDelivery]" 
                                                       value="{{ order.shipping.estimatedDelivery | date('YYYY-MM-DDTHH:mm') if order and order.shipping.estimatedDelivery }}">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Payment Information</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label class="form-label" for="paymentMethod">Payment Method</label>
                                                <select class="form-select" id="paymentMethod" name="payment[method]">
                                                    <option value="cod" {{ 'selected' if (order and order.payment.method == 'cod') or (not order) }}>Cash on Delivery</option>
                                                    <option value="prepaid" {{ 'selected' if (order and order.payment.method == 'prepaid') }}>Prepaid</option>
                                                    <option value="card" {{ 'selected' if (order and order.payment.method == 'card') }}>Credit/Debit Card</option>
                                                    <option value="upi" {{ 'selected' if (order and order.payment.method == 'upi') }}>UPI</option>
                                                    <option value="netbanking" {{ 'selected' if (order and order.payment.method == 'netbanking') }}>Net Banking</option>
                                                    <option value="wallet" {{ 'selected' if (order and order.payment.method == 'wallet') }}>Wallet</option>
                                                </select>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label" for="paymentStatus">Payment Status</label>
                                                <select class="form-select" id="paymentStatus" name="payment[status]">
                                                    <option value="pending" {{ 'selected' if (order and order.payment.status == 'pending') or (not order) }}>Pending</option>
                                                    <option value="processing" {{ 'selected' if (order and order.payment.status == 'processing') }}>Processing</option>
                                                    <option value="completed" {{ 'selected' if (order and order.payment.status == 'completed') }}>Completed</option>
                                                    <option value="failed" {{ 'selected' if (order and order.payment.status == 'failed') }}>Failed</option>
                                                    <option value="refunded" {{ 'selected' if (order and order.payment.status == 'refunded') }}>Refunded</option>
                                                </select>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label" for="transactionId">Transaction ID</label>
                                                <input type="text" 
                                                       class="form-control" 
                                                       id="transactionId"
                                                       name="payment[transactionId]" 
                                                       value="{{ order.payment.transactionId if order else formData.transactionId or '' }}">
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label" for="paymentGateway">Payment Gateway</label>
                                                <input type="text" 
                                                       class="form-control" 
                                                       id="paymentGateway"
                                                       name="payment[paymentGateway]" 
                                                       value="{{ order.payment.paymentGateway if order else formData.paymentGateway or '' }}">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Quick Actions -->
            {% if order %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-outline-primary" onclick="printInvoice()">
                            <i class="bx bx-printer"></i> Print Invoice
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="sendOrderUpdate()">
                            <i class="bx bx-mail-send"></i> Send Update to Customer
                        </button>
                        {% if order.shipping.trackingNumber %}
                        <button type="button" class="btn btn-outline-success" onclick="trackOrder()">
                            <i class="bx bx-map-pin"></i> Track Order
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Order Summary -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Order Summary</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Items:</span>
                        <span id="summaryItems">{{ order.totalItems if order else '0' }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Subtotal:</span>
                        <span id="summarySubtotal">${{ order.subtotal if order else '0.00' }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Shipping:</span>
                        <span id="summaryShipping">${{ order.shippingCost if order else '0.00' }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Tax:</span>
                        <span id="summaryTax">${{ order.taxAmount if order else '0.00' }}</span>
                    </div>
                    {% if order and order.discountAmount > 0 %}
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Discount:</span>
                        <span id="summaryDiscount" class="text-success">-${{ order.discountAmount }}</span>
                    </div>
                    {% endif %}
                    <hr>
                    <div class="d-flex justify-content-between">
                        <strong>Total:</strong>
                        <strong id="summaryTotal">${{ order.totalAmount if order else '0.00' }}</strong>
                    </div>
                </div>
            </div>

            {% if order %}
            <!-- Order Timeline -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Order Timeline</h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <div class="timeline-item">
                            <div class="timeline-point timeline-point-success"></div>
                            <div class="timeline-event">
                                <div class="timeline-header">
                                    <h6 class="timeline-title">Order Placed</h6>
                                    <small class="text-muted">{{ order.orderDate | date('MMM DD, YYYY HH:mm') }}</small>
                                </div>
                            </div>
                        </div>
                        
                        {% if order.confirmedAt %}
                        <div class="timeline-item">
                            <div class="timeline-point timeline-point-primary"></div>
                            <div class="timeline-event">
                                <div class="timeline-header">
                                    <h6 class="timeline-title">Order Confirmed</h6>
                                    <small class="text-muted">{{ order.confirmedAt | date('MMM DD, YYYY HH:mm') }}</small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if order.shippedAt %}
                        <div class="timeline-item">
                            <div class="timeline-point timeline-point-info"></div>
                            <div class="timeline-event">
                                <div class="timeline-header">
                                    <h6 class="timeline-title">Order Shipped</h6>
                                    <small class="text-muted">{{ order.shippedAt | date('MMM DD, YYYY HH:mm') }}</small>
                                </div>
                                {% if order.shipping.trackingNumber %}
                                <p class="timeline-body">Tracking: {{ order.shipping.trackingNumber }}</p>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if order.deliveredAt %}
                        <div class="timeline-item">
                            <div class="timeline-point timeline-point-success"></div>
                            <div class="timeline-event">
                                <div class="timeline-header">
                                    <h6 class="timeline-title">Order Delivered</h6>
                                    <small class="text-muted">{{ order.deliveredAt | date('MMM DD, YYYY HH:mm') }}</small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if order.cancelledAt %}
                        <div class="timeline-item">
                            <div class="timeline-point timeline-point-danger"></div>
                            <div class="timeline-event">
                                <div class="timeline-header">
                                    <h6 class="timeline-title">Order Cancelled</h6>
                                    <small class="text-muted">{{ order.cancelledAt | date('MMM DD, YYYY HH:mm') }}</small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Form Actions -->
            <div class="card">
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bx bx-save"></i>
                            {{ 'Update Order' if order else 'Create Order' }}
                        </button>
                        <a href="/orders" class="btn btn-outline-secondary">
                            <i class="bx bx-arrow-back"></i>
                            Back to Orders
                        </a>
                        {% if order %}
                        <a href="/orders/{{ order._id }}" class="btn btn-outline-info">
                            <i class="bx bx-show"></i>
                            View Full Details
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Add Item Modal -->
<div class="modal fade" id="addItemModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Order Item</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-8">
            <div class="mb-3">
              <label class="form-label">Product</label>
              <select class="form-select" id="productSelect">
                <option value="">Search and select product...</option>
                {% if products %}
                {% for product in products %}
                <option value="{{ product._id }}" 
                        data-name="{{ product.name }}"
                        data-sku="{{ product.sku }}"
                        data-price="{{ product.price }}"
                        data-image="{{ product.images[0] if product.images and product.images.length }}">
                  {{ product.name }} ({{ product.sku }}) - ${{ product.price }}
                </option>
                {% endfor %}
                {% endif %}
              </select>
            </div>
          </div>
          <div class="col-md-4">
            <div class="mb-3">
              <label class="form-label">Quantity</label>
              <input type="number" class="form-control" id="itemQuantity" value="1" min="1">
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">Unit Price</label>
              <input type="number" class="form-control" id="itemPrice" step="0.01" readonly>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">Total Price</label>
              <input type="number" class="form-control" id="itemTotal" step="0.01" readonly>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="confirmAddItem()">Add Item</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block js %}
<script src="/assets/vendor/libs/datatables-bs5/datatables-bootstrap5.js"></script>
<script>
let itemIndex = {{ order.items.length if order and order.items else 0 }};

document.addEventListener('DOMContentLoaded', function() {
    initializeForm();
    initializeItemModal();
    calculateTotals();
});

function initializeForm() {
    const form = document.getElementById('orderForm');
    const customerSelect = document.getElementById('customer');
    
    // Update customer email/phone when customer is selected
    customerSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.value) {
            document.getElementById('customerEmail').value = selectedOption.dataset.email || '';
            document.getElementById('customerPhone').value = selectedOption.dataset.phone || '';
        } else {
            document.getElementById('customerEmail').value = '';
            document.getElementById('customerPhone').value = '';
        }
    });
    
    // Form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (validateForm()) {
            submitForm();
        }
    });
    
    // Auto-calculate totals when values change
    ['subtotal', 'shippingCost', 'taxAmount', 'discountAmount'].forEach(field => {
        document.getElementById(field).addEventListener('input', calculateTotals);
    });
}

function initializeItemModal() {
    const productSelect = document.getElementById('productSelect');
    const quantityInput = document.getElementById('itemQuantity');
    const priceInput = document.getElementById('itemPrice');
    const totalInput = document.getElementById('itemTotal');
    
    productSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.value) {
            priceInput.value = selectedOption.dataset.price || '0';
            calculateItemTotal();
        } else {
            priceInput.value = '';
            totalInput.value = '';
        }
    });
    
    quantityInput.addEventListener('input', calculateItemTotal);
}

function calculateItemTotal() {
    const quantity = parseFloat(document.getElementById('itemQuantity').value) || 0;
    const price = parseFloat(document.getElementById('itemPrice').value) || 0;
    const total = quantity * price;
    
    document.getElementById('itemTotal').value = total.toFixed(2);
}

function calculateTotals() {
    const subtotal = parseFloat(document.getElementById('subtotal').value) || 0;
    const shipping = parseFloat(document.getElementById('shippingCost').value) || 0;
    const tax = parseFloat(document.getElementById('taxAmount').value) || 0;
    const discount = parseFloat(document.getElementById('discountAmount').value) || 0;
    
    const total = subtotal + shipping + tax - discount;
    document.getElementById('totalAmount').value = total.toFixed(2);
    
    // Update summary
    document.getElementById('summarySubtotal').textContent = '$' + subtotal.toFixed(2);
    document.getElementById('summaryShipping').textContent = '$' + shipping.toFixed(2);
    document.getElementById('summaryTax').textContent = '$' + tax.toFixed(2);
    document.getElementById('summaryTotal').textContent = '$' + total.toFixed(2);
    
    if (discount > 0) {
        document.getElementById('summaryDiscount').textContent = '-$' + discount.toFixed(2);
    }
}

function addOrderItem() {
    $('#addItemModal').modal('show');
}

function confirmAddItem() {
    const productSelect = document.getElementById('productSelect');
    const selectedOption = productSelect.options[productSelect.selectedIndex];
    
    if (!selectedOption.value) {
        Swal.fire('Error!', 'Please select a product', 'error');
        return;
    }
    
    const quantity = parseInt(document.getElementById('itemQuantity').value) || 1;
    const price = parseFloat(document.getElementById('itemPrice').value) || 0;
    const total = parseFloat(document.getElementById('itemTotal').value) || 0;
    
    // Add item to the form
    addItemToForm({
        productId: selectedOption.value,
        productName: selectedOption.dataset.name,
        productSku: selectedOption.dataset.sku,
        quantity: quantity,
        unitPrice: price,
        totalPrice: total,
        productImage: selectedOption.dataset.image
    });
    
    $('#addItemModal').modal('hide');
    
    // Reset modal
    productSelect.selectedIndex = 0;
    document.getElementById('itemQuantity').value = '1';
    document.getElementById('itemPrice').value = '';
    document.getElementById('itemTotal').value = '';
}

function addItemToForm(item) {
    const container = document.getElementById('orderItemsContainer');
    
    // Remove empty state if exists
    const emptyState = container.querySelector('.text-center');
    if (emptyState) {
        emptyState.remove();
    }
    
    const itemHtml = generateItemRow(item, itemIndex);
    container.insertAdjacentHTML('beforeend', itemHtml);
    
    itemIndex++;
    recalculateSubtotal();
}

function generateItemRow(item, index) {
    return `
        <div class="order-item-row" data-index="${index}">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <h6>${item.productName}</h6>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeItem(${index})">
                    <i class="bx bx-trash"></i>
                </button>
            </div>
            
            <input type="hidden" name="items[${index}][product]" value="${item.productId}">
            <input type="hidden" name="items[${index}][productName]" value="${item.productName}">
            <input type="hidden" name="items[${index}][productSku]" value="${item.productSku}">
            <input type="hidden" name="items[${index}][productImage]" value="${item.productImage || ''}">
            
            <div class="row">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">Quantity</label>
                        <input type="number" class="form-control item-quantity" 
                               name="items[${index}][quantity]" 
                               value="${item.quantity}" 
                               min="1" 
                               onchange="updateItemTotal(${index})">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">Unit Price</label>
                        <input type="number" class="form-control item-price" 
                               name="items[${index}][unitPrice]" 
                               value="${item.unitPrice}" 
                               step="0.01" 
                               onchange="updateItemTotal(${index})">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">Total</label>
                        <input type="number" class="form-control item-total" 
                               name="items[${index}][totalPrice]" 
                               value="${item.totalPrice}" 
                               step="0.01" 
                               readonly>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function removeItem(index) {
    document.querySelector(`[data-index="${index}"]`).remove();
    recalculateSubtotal();
}

function updateItemTotal(index) {
    const row = document.querySelector(`[data-index="${index}"]`);
    const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
    const price = parseFloat(row.querySelector('.item-price').value) || 0;
    const total = quantity * price;
    
    row.querySelector('.item-total').value = total.toFixed(2);
    recalculateSubtotal();
}

function recalculateSubtotal() {
    let subtotal = 0;
    document.querySelectorAll('.item-total').forEach(input => {
        subtotal += parseFloat(input.value) || 0;
    });
    
    document.getElementById('subtotal').value = subtotal.toFixed(2);
    calculateTotals();
}

function copyShippingToBilling() {
    const checkbox = document.getElementById('sameAsShipping');
    
    if (checkbox.checked) {
        // Copy all shipping address fields to billing
        const shippingFields = ['firstName', 'lastName', 'company', 'addressLine1', 'addressLine2', 'city', 'state', 'postalCode', 'country', 'phone'];
        
        shippingFields.forEach(field => {
            const shippingInput = document.querySelector(`[name="shippingAddress[${field}]"]`);
            const billingInput = document.querySelector(`[name="billingAddress[${field}]"]`);
            
            if (shippingInput && billingInput) {
                billingInput.value = shippingInput.value;
            }
        });
    }
}

function validateForm() {
    // Basic validation
    const customer = document.getElementById('customer').value;
    
    if (!customer) {
        showFieldError('customer', 'Please select a customer');
        return false;
    }
    
    // Check if at least one item exists
    const items = document.querySelectorAll('.order-item-row');
    if (items.length === 0) {
        Swal.fire('Error!', 'Please add at least one item to the order', 'error');
        // Switch to items tab
        const itemsTab = document.querySelector('[data-bs-target="#order-items"]');
        new bootstrap.Tab(itemsTab).show();
        return false;
    }
    
    return true;
}

function showFieldError(fieldName, message) {
    const field = document.getElementById(fieldName);
    const feedback = field.parentNode.querySelector('.invalid-feedback');
    
    field.classList.add('is-invalid');
    if (feedback) {
        feedback.textContent = message;
    }
    
    field.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function submitForm() {
    const form = document.getElementById('orderForm');
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    // Show loading state
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
    
    const formData = new FormData(form);
    
    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire({
                title: 'Success!',
                text: data.message,
                icon: 'success',
                confirmButtonText: 'OK'
            }).then(() => {
                if (data.redirectUrl) {
                    window.location.href = data.redirectUrl;
                } else {
                    window.location.href = '/orders';
                }
            });
        } else {
            if (data.errors) {
                Object.keys(data.errors).forEach(fieldName => {
                    showFieldError(fieldName, data.errors[fieldName]);
                });
            } else {
                Swal.fire('Error!', data.message || 'Something went wrong', 'error');
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire('Error!', 'Something went wrong', 'error');
    })
    .finally(() => {
        // Reset button state
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
}

{% if order %}
function printInvoice() {
    window.open(`/orders/{{ order._id }}/invoice/print`, '_blank');
}

function sendOrderUpdate() {
    Swal.fire({
        title: 'Send Order Update?',
        text: 'This will send an email notification to the customer about their order status',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Send Update'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/orders/{{ order._id }}/send-update`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('Sent!', data.message, 'success');
                } else {
                    Swal.fire('Error!', data.message, 'error');
                }
            });
        }
    });
}

function trackOrder() {
    {% if order.shipping.trackingUrl %}
    window.open('{{ order.shipping.trackingUrl }}', '_blank');
    {% else %}
    Swal.fire('Info', 'Tracking information will be available once the order is shipped', 'info');
    {% endif %}
}
{% endif %}
</script>
{% endblock %}
