{% extends "layouts/admin.njk" %}

{% block title %}Products - {{ APP_NAME }}{% endblock %}

{% set pageTitle = "Products" %}
{% set breadcrumbActive = "Products" %}
{% set currentPage = "products" %}

{% block content %}
<!-- [ Main Content ] start -->

<!-- Products Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex align-items-center justify-content-between">
                    <h5 class="mb-0">All Products</h5>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-secondary btn-sm" onclick="exportProducts()">
                            <i class="ti ti-download me-1"></i>Export
                        </button>
                        <a href="/products/new" class="btn btn-primary btn-sm">
                            <i class="ti ti-plus me-1"></i>Add Product
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="card-body">
                <!-- Filters -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <select class="form-select" id="statusFilter">
                            <option value="">All Status</option>
                            <option value="published">Published</option>
                            <option value="draft">Draft</option>
                            <option value="archived">Archived</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="categoryFilter">
                            <option value="">All Categories</option>
                            {% for category in categories %}
                            <option value="{{ category._id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="brandFilter">
                            <option value="">All Brands</option>
                            {% for brand in brands %}
                            <option value="{{ brand._id }}">{{ brand.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="text" class="form-control" id="searchFilter" placeholder="Search products...">
                    </div>
                </div>
                
                <!-- Products Table -->
                <div class="table-responsive">
                    <table class="table table-hover" id="productsTable">
                        <thead>
                            <tr>
                                <th>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="selectAll">
                                    </div>
                                </th>
                                <th>Product</th>
                                <th>SKU</th>
                                <th>Category</th>
                                <th>Price</th>
                                <th>Stock</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if products and products.length %}
                            {% for product in products %}
                            <tr>
                                <td>
                                    <div class="form-check">
                                        <input class="form-check-input product-checkbox" type="checkbox" value="{{ product._id }}">
                                    </div>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="flex-shrink-0">
                                            {% if product.image %}
                                            <img src="{{ product.image }}" alt="{{ product.name }}" 
                                                 class="img-thumbnail" style="width: 50px; height: 50px; object-fit: cover;">
                                            {% else %}
                                            <div class="bg-light d-flex align-items-center justify-content-center img-thumbnail" 
                                                 style="width: 50px; height: 50px;">
                                                <i class="ti ti-photo text-muted"></i>
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div class="flex-grow-1 ms-3">
                                            <h6 class="mb-1">
                                                <a href="/products/{{ product._id }}" class="text-decoration-none">
                                                    {{ product.name }}
                                                </a>
                                            </h6>
                                            <small class="text-muted">{{ product.description | truncate(50) }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td><code>{{ product.sku }}</code></td>
                                <td>
                                    {% if product.category %}
                                    <span class="badge bg-light text-dark">{{ product.category.name }}</span>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td><strong>${{ product.price | number }}</strong></td>
                                <td>
                                    {% if product.stock <= 10 %}
                                    <span class="badge bg-danger">{{ product.stock }}</span>
                                    {% elif product.stock <= 50 %}
                                    <span class="badge bg-warning">{{ product.stock }}</span>
                                    {% else %}
                                    <span class="badge bg-success">{{ product.stock }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if product.status == 'published' %}
                                    <span class="badge bg-success">Published</span>
                                    {% elif product.status == 'draft' %}
                                    <span class="badge bg-secondary">Draft</span>
                                    {% else %}
                                    <span class="badge bg-warning">{{ product.status | title }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">{{ product.createdAt | date('MMM DD, YYYY') }}</small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="/products/{{ product._id }}" 
                                           class="btn btn-outline-primary btn-sm" title="View">
                                            <i class="ti ti-eye"></i>
                                        </a>
                                        <a href="/products/{{ product._id }}/edit" 
                                           class="btn btn-outline-secondary btn-sm" title="Edit">
                                            <i class="ti ti-pencil"></i>
                                        </a>
                                        <button class="btn btn-outline-danger btn-sm" 
                                                onclick="deleteProduct('{{ product._id }}')" title="Delete">
                                            <i class="ti ti-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="9" class="text-center py-5">
                                    <i class="ti ti-package text-muted" style="font-size: 3rem;"></i>
                                    <h6 class="mt-3 text-muted">No products found</h6>
                                    <p class="text-muted">
                                        <a href="/products/new" class="btn btn-primary btn-sm">
                                            <i class="ti ti-plus me-1"></i>Add your first product
                                        </a>
                                    </p>
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                {% if pagination %}
                <nav aria-label="Products pagination" class="mt-4">
                    <ul class="pagination justify-content-center">
                        <li class="page-item {{ 'disabled' if pagination.currentPage <= 1 }}">
                            <a class="page-link" href="?page={{ pagination.currentPage - 1 }}">Previous</a>
                        </li>
                        
                        {% for page in pagination.pages %}
                        <li class="page-item {{ 'active' if page == pagination.currentPage }}">
                            <a class="page-link" href="?page={{ page }}">{{ page }}</a>
                        </li>
                        {% endfor %}
                        
                        <li class="page-item {{ 'disabled' if pagination.currentPage >= pagination.totalPages }}">
                            <a class="page-link" href="?page={{ pagination.currentPage + 1 }}">Next</a>
                        </li>
                    </ul>
                </nav>
                {% endif %}
            </div>
        </div>
    </div>
</div>
<!-- [ Main Content ] end -->
{% endblock %}

{% block js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Filter functionality
    const statusFilter = document.getElementById('statusFilter');
    const categoryFilter = document.getElementById('categoryFilter');
    const brandFilter = document.getElementById('brandFilter');
    const searchFilter = document.getElementById('searchFilter');
    
    let searchTimeout;
    
    // Add event listeners for filters
    [statusFilter, categoryFilter, brandFilter].forEach(filter => {
        filter.addEventListener('change', applyFilters);
    });
    
    searchFilter.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(applyFilters, 500);
    });
    
    // Select all functionality
    const selectAll = document.getElementById('selectAll');
    const productCheckboxes = document.querySelectorAll('.product-checkbox');
    
    selectAll.addEventListener('change', function() {
        productCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
    });
    
    // Apply filters
    function applyFilters() {
        const params = new URLSearchParams(window.location.search);
        
        // Update URL parameters
        if (statusFilter.value) params.set('status', statusFilter.value);
        else params.delete('status');
        
        if (categoryFilter.value) params.set('category', categoryFilter.value);
        else params.delete('category');
        
        if (brandFilter.value) params.set('brand', brandFilter.value);
        else params.delete('brand');
        
        if (searchFilter.value) params.set('search', searchFilter.value);
        else params.delete('search');
        
        // Reset to first page when filtering
        params.delete('page');
        
        // Reload page with new parameters
        window.location.search = params.toString();
    }
    
    // Bulk actions
    document.addEventListener('click', function(e) {
        if (e.target.matches('[data-bulk-action]')) {
            const action = e.target.dataset.bulkAction;
            const selectedProducts = Array.from(document.querySelectorAll('.product-checkbox:checked'))
                                          .map(cb => cb.value);
            
            if (selectedProducts.length === 0) {
                alert('Please select products to perform this action.');
                return;
            }
            
            performBulkAction(action, selectedProducts);
        }
    });
});

// Delete product function
function deleteProduct(productId) {
    if (confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
        fetch(`/products/${productId}`, {
            method: 'DELETE',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove row from table
                document.querySelector(`input[value="${productId}"]`).closest('tr').remove();
                showToast('Product deleted successfully', 'success');
            } else {
                showToast(data.message || 'Failed to delete product', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('An error occurred while deleting the product', 'error');
        });
    }
}

// Export products function
function exportProducts() {
    const params = new URLSearchParams(window.location.search);
    params.set('export', 'csv');
    
    window.location.href = `/products?${params.toString()}`;
}

// Bulk actions
function performBulkAction(action, productIds) {
    let confirmMessage = '';
    let endpoint = '/products/bulk';
    
    switch (action) {
        case 'delete':
            confirmMessage = `Are you sure you want to delete ${productIds.length} products? This action cannot be undone.`;
            break;
        case 'publish':
            confirmMessage = `Publish ${productIds.length} products?`;
            break;
        case 'draft':
            confirmMessage = `Move ${productIds.length} products to draft?`;
            break;
        default:
            return;
    }
    
    if (!confirm(confirmMessage)) return;
    
    fetch(endpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            action: action,
            productIds: productIds
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message || 'Bulk action completed successfully', 'success');
            // Reload page to show updates
            window.location.reload();
        } else {
            showToast(data.message || 'Bulk action failed', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('An error occurred during bulk action', 'error');
    });
}

// Toast notification function
function showToast(message, type = 'info') {
    // Create toast element if it doesn't exist
    let toastContainer = document.querySelector('.toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        document.body.appendChild(toastContainer);
    }
    
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}
</script>
{% endblock %}