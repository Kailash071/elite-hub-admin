{% extends "layouts/admin.njk" %}

{% block title %}Products - {{ APP_NAME }}{% endblock %}

{% set pageTitle = "Products" %}
{% set breadcrumbActive = "Products" %}
{% set currentPage = "products" %}

{% block content %}
<!-- [ Main Content ] start -->

<!-- Products Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex align-items-center justify-content-between">
                    <h5 class="mb-0">All Products</h5>
                    <div class="d-flex gap-2">
                         <div id="bulkActionsContainer">
                            <!-- Helper for bulk actions -->
                         </div>
                        <button class="btn btn-outline-secondary btn-sm" onclick="exportProducts()">
                            <i class="ti ti-download me-1"></i>Export
                        </button>
                        <a href="/products/new" class="btn btn-primary btn-sm">
                            <i class="ti ti-plus me-1"></i>Add Product
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="card-body">
                <!-- Filters -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <select class="form-select" id="statusFilter">
                            <option value="">All Status</option>
                            <option value="published">Published</option>
                            <option value="draft">Draft</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="categoryFilter">
                            <option value="">All Categories</option>
                            {% for category in categories %}
                            <option value="{{ category._id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="brandFilter">
                            <option value="">All Brands</option>
                            {% for brand in brands %}
                            <option value="{{ brand._id }}">{{ brand.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <!-- Products Table -->
                <div class="table-responsive">
                    <table class="table table-hover" id="productsTable">
                        <thead>
                            <tr>
                                <th>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="selectAll">
                                    </div>
                                </th>
                                <th>Product</th>
                                <th>SKU</th>
                                <th>Category</th>
                                <th>Price</th>
                                <th>Stock</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- DataTable will populate this -->
                        </tbody>
                    </table>
                </div>

            </div>
        </div>
    </div>
</div>
<!-- [ Main Content ] end -->
{% endblock %}

{% block js %}
<script>
let productsTable;

document.addEventListener('DOMContentLoaded', function() {
    initializeDataTable();
    initializeEventListeners();
    
    // Filter functionality
    const statusFilter = document.getElementById('statusFilter');
    const categoryFilter = document.getElementById('categoryFilter');
    const brandFilter = document.getElementById('brandFilter');
    
    [statusFilter, categoryFilter, brandFilter].forEach(filter => {
        if(filter) filter.addEventListener('change', () => productsTable.ajax.reload());
    });
});

function initializeDataTable() {
    productsTable = $('#productsTable').DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: '/products/datatable',
            type: 'POST',
            data: function(d) {
                d.status = $('#statusFilter').val();
                d.category = $('#categoryFilter').val();
                d.brand = $('#brandFilter').val();
            }
        },
        columns: [
            { 
                data: '_id',
                orderable: false,
                searchable: false,
                render: function(data) {
                    return `<div class="form-check"><input class="form-check-input product-checkbox" type="checkbox" value="${data}"></div>`;
                }
            },
            { 
                data: 'name',
                name: 'name',
                render: function(data, type, row) {
                    const img = row.image ? `<img src="${row.image}" class="img-thumbnail me-2" style="width: 40px; height: 40px; object-fit: cover;">` : 
                                            `<div class="avatar avatar-sm me-2"><span class="avatar-initial rounded bg-label-secondary"><i class="bx bx-package"></i></span></div>`;
                    return `<div class="d-flex align-items-center">
                                ${img}
                                <div>
                                    <h6 class="mb-0 text-truncate" style="max-width: 200px;">${data}</h6>
                                </div>
                            </div>`;
                }
            },
            { data: 'sku', name: 'sku' },
             { 
                data: 'category',
                name: 'category', // Actually mainCategory
                render: function(data) {
                    return data ? `<span class="badge bg-label-primary">${data.name || 'Category'}</span>` : '-';
                }
            },
            { 
                data: 'price', 
                name: 'price',
                render: function(data) {
                    return `CA$${parseFloat(data).toFixed(2)}`;
                }
            },
            { 
                data: 'stock', 
                name: 'stockQuantity',
                render: function(data, type, row) {
                    let color = 'success';
                    if(row.stockStatus === 'out_of_stock') color = 'danger';
                    else if(row.stockStatus === 'low_stock') color = 'warning';
                    return `<span class="badge bg-label-${color}">${data}</span>`;
                }
            },
            { 
                data: 'status', 
                name: 'isActive',
                render: function(data) {
                    return data === 'published' ? '<span class="badge bg-label-success">Published</span>' : '<span class="badge bg-label-secondary">Draft</span>';
                }
            },
            { 
                data: 'createdAt', 
                name: 'createdAt',
                render: function(data) {
                    return new Date(data).toLocaleDateString();
                }
            },
            {
                data: null,
                orderable: false,
                render: function(data, type, row) {
                     return `
                        <div class="d-flex gap-1">
                            <a href="/products/${row._id}" class="btn btn-icon btn-sm btn-text-secondary rounded-pill"><i class="bx bx-show"></i></a>
                            <a href="/products/${row._id}/edit" class="btn btn-icon btn-sm btn-text-primary rounded-pill"><i class="bx bx-edit"></i></a>
                            <button class="btn btn-icon btn-sm btn-text-danger rounded-pill" onclick="deleteProduct('${row._id}')"><i class="bx bx-trash"></i></button>
                        </div>
                    `;
                }
            }
        ],
        dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>t<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
        language: {
            search: "",
            searchPlaceholder: "Search products..."
        }
    });
}

function initializeEventListeners() {
    $('#selectAll').on('change', function() {
        $('.product-checkbox').prop('checked', $(this).prop('checked'));
        updateBulkActions();
    });
    
    $(document).on('change', '.product-checkbox', function() {
        updateBulkActions();
        
        const allChecked = $('.product-checkbox:checked').length === $('.product-checkbox').length;
        $('#selectAll').prop('checked', allChecked);
    });
}

function updateBulkActions() {
    const checkedCount = $('.product-checkbox:checked').length;
    const container = $('#bulkActionsContainer');
    
    if (checkedCount > 0) {
        container.html(`
            <div class="dropdown d-inline-block">
                <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    Actions (${checkedCount})
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="performBulkAction('publish')"><i class="bx bx-check me-2"></i>Publish</a></li>
                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="performBulkAction('draft')"><i class="bx bx-file me-2"></i>Draft</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="javascript:void(0)" onclick="performBulkAction('delete')"><i class="bx bx-trash me-2"></i>Delete</a></li>
                </ul>
            </div>
        `);
    } else {
        container.empty();
    }
}

function deleteProduct(productId) {
    Swal.fire({
        title: 'Are you sure?',
        text: "You won't be able to revert this!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, delete it!',
        customClass: {
            confirmButton: 'btn btn-primary me-3',
            cancelButton: 'btn btn-label-secondary'
        },
        buttonsStyling: false
    }).then(function(result) {
        if (result.value) {
            fetch(`/products/${productId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Deleted!',
                        text: 'Product has been deleted.',
                        customClass: {
                            confirmButton: 'btn btn-success'
                        }
                    });
                    productsTable.ajax.reload();
                } else {
                    Swal.fire('Error', data.message || 'Failed to delete', 'error');
                }
            });
        }
    });
}

function performBulkAction(action) {
    const selectedIds = $('.product-checkbox:checked').map(function() { return $(this).val(); }).get();
    
    if(selectedIds.length === 0) return;
    
    fetch('/products/bulk', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action, productIds: selectedIds })
    })
    .then(res => res.json())
    .then(data => {
        if(data.success) {
            Swal.fire('Success', data.message, 'success');
            productsTable.ajax.reload();
            $('#selectAll').prop('checked', false);
            updateBulkActions();
        } else {
            Swal.fire('Error', data.message, 'error');
        }
    });
}

function exportProducts() {
    window.location.href = '/products?export=true';
}
</script>
{% endblock %}